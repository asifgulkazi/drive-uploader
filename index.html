<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Direct to Google Drive (Resumable Upload)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Improve connection to GIS host -->
  https://accounts.google.com
  https://accounts.google.com

  <!-- Google Identity Services -->
  <script id="gis" src="https://accounts.google.com/gsi/client" asynced:#667085; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626; }
    body { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; max-width: 1000px; }
    .muted { color: var(--muted); }
    progress { width: 100%; height: 12px; }
    .file { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin: 10px 0; }
    .panel { border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fafafa; margin:12px 0; }
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
    .hidden{display:none}
    button { cursor:pointer }
  </style>
</head>
<body>
  <h1>Direct Upload to Google Drive (Resumable)</h1>
  <p class="muted">Authorize once, then upload files directly to your Drive with resume support.</p>

  <div class="panel">
    <button id="auth">Authorize</button>
    <label style="margin-left:1rem">Optional target folder ID:
      <input id="folder" type="text" placeholder="leave blank for My Drive root" style="width:360px">
    </label>
    <div id="statusLine" class="muted" style="margin-top:8px;">Ready.</div>
  </div>

  <!-- Diagnostics (auto-shows only if there’s a problem) -->
  <div id="diagBox" class="panel hidden">
    <b>Diagnostics</b>
    <div>GIS script loaded: <span id="gisLoaded" class="warn">waiting…</span></div>
    <div>Token client init: <span id="tcInit" class="warn">waiting…</span></div>
    <div>Last event: <span id="last">-</span></div>
    <div>Error: <span id="err" class="err">-</span></div>
    <div class="muted">Tip: If nothing happens on Authorize, allow pop‑ups for <code>asifgulkazi.github.io</code> or try an Incognito window (disables extensions).</div>
  </div>

  <input id="picker" type="file" multiple style="display:block;margin:1rem 0">
  <div id="list"></div>

  <script>
    // ========= CONFIG =========
    const CLIENT_ID = '261750495231-jr3v20mqpou39i9bch15vcu5t6lhqscj.apps.googleusercontent.com'; // your Client ID
    const SCOPE = 'https://www.googleapis.com/auth/drive.file'; // least-privilege
    const CHUNK_SIZE = 8 * 1024 * 1024; // 8 MiB chunks
    // ==========================

    // Helpers
    const $ = s => document.querySelector(s);
    const showDiag = () => $('#diagBox').classList.remove('hidden');
    const set = (id, text, cls) => { const el = document.getElementById(id); el.textContent = text; if (cls) el.className = cls; };
    const setLine = (msg, cls) => { const s = document.getElementById('statusLine'); s.textContent = msg; s.className = cls || 'muted'; };
    const logLast = m => { set('last', m); showDiag(); };
    const logErr  = m => { set('err', m || '-'); showDiag(); };

    let tokenClient = null, accessToken = null;

    // Try to init as soon as GIS script loads
    const gisEl = document.getElementById('gis');
    gisEl.addEventListener('load', () => {
      set('gisLoaded', 'yes', 'ok');
      initTokenClient();
    });
    gisEl.addEventListener('error', () => {
      set('gisLoaded', 'load error', 'err');
      logErr('Failed to load GIS (network or extension blocking accounts.google.com).');
      setLine('GIS library failed to load. Try Incognito / allow pop-ups.', 'err');
    });

    // Safety: also poll for up to 30 seconds in case load event is missed by the browser
    let pollCount = 0, pollTimer = setInterval(() => {
      if (window.google && google.accounts && google.accounts.oauth2) {
        set('gisLoaded', 'yes', 'ok');
        clearInterval(pollTimer);
        if (!tokenClient) initTokenClient();
      } else {
        set('gisLoaded', 'loading…', 'warn');
        if (++pollCount > 150) { // ~30s (150 * 200ms)
          clearInterval(pollTimer);
          set('gisLoaded', 'timeout', 'err');
          logErr('GIS library did not load (check blockers/DNS).');
          setLine('GIS library did not load. Try Incognito / disable extensions / check network.', 'err');
        }
      }
    }, 200);

    function initTokenClient() {
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPE,
          callback: (resp) => {
            if (resp && resp.access_token) {
              accessToken = resp.access_token;
              setLine('Authorized. You can select files now.', 'ok');
            } else if (resp && resp.error) {
              logLast('Callback error');
              logErr(resp.error + (resp.error_description ? (': ' + resp.error_description) : ''));
              setLine('Authorization failed. See diagnostics below.', 'err');
            } else {
              logLast('Callback without token');
              logErr('No access token returned.');
              setLine('Authorization failed. See diagnostics below.', 'err');
            }
          }
        });
        set('tcInit', 'yes', 'ok');
      } catch (e) {
        set('tcInit', 'failed', 'err');
        logErr('initTokenClient error: ' + e.message);
        setLine('Authorization init failed. See diagnostics.', 'err');
      }
    }

    window.addEventListener('unhandledrejection', e => { logLast('Promise rejection'); logErr(String(e.reason || e)); });
    window.addEventListener('error', e => { logLast('Window error'); logErr((e.error && e.error.message) || e.message); });

    document.getElementById('auth').onclick = () => {
      logErr('-');
      if (!tokenClient) {
        logLast('Token client not ready');
        logErr('GIS not loaded or CLIENT_ID invalid.');
        setLine('Token client not ready. If you use extensions, try Incognito.', 'err');
        return;
      }
      setLine('Requesting authorization…');
      try {
        tokenClient.requestAccessToken({ prompt: '' }); // request token; popup may appear first time
        setTimeout(() => {
          if (!accessToken) {
            logErr('No token yet. If nothing happened, allow pop‑ups for this site.');
            setLine('Awaiting popup / consent… If blocked, allow pop‑ups.', 'warn');
          }
        }, 1500);
      } catch (e) {
        logLast('requestAccessToken threw');
        logErr(e.message);
        setLine('Authorization failed. See diagnostics below.', 'err');
      }
    };

    function row(name) {
      const div = document.createElement('div');
      div.className = 'file';
      div.innerHTML = `
        <div><b>${name.replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</b></div>
        <progress value="0" max="100"></progress>
        <div class="muted" data-status>Waiting…</div>`;
      document.getElementById('list').appendChild(div);
      return div;
    }

    async function startResumable(file, folderId) {
      const metadata = { name: file.name };
      if (folderId) metadata.parents = [folderId];
      const initRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json; charset=UTF-8',
          'X-Upload-Content-Type': file.type || 'application/octet-stream',
          'X-Upload-Content-Length': String(file.size)
        },
        body: JSON.stringify(metadata)
      });
      if (!initRes.ok) throw new Error('init ' + initRes.status);
      return initRes.headers.get('Location');
    }

    async function uploadChunks(sessionUrl, file, onProgress) {
      let offset = 0;
      while (offset < file.size) {
        const end = Math.min(offset + CHUNK_SIZE, file.size);
        const chunk = file.slice(offset, end);
        const res = await fetch(sessionUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': file.type || 'application/octet-stream',
            'Content-Length': String(chunk.size),
            'Content-Range': `bytes ${offset}-${end-1}/${file.size}`
          },
          body: chunk
        });

        if (res.status === 308) {
          const range = res.headers.get('Range'); // "bytes=0-8388607"
          if (range) {
            const m = range.match(/-(\d+)$/);
            offset = m ? (parseInt(m[1],10) + 1) : end;
          } else {
            offset = end;
          }
          onProgress(Math.round((offset / file.size) * 100));
        } else if (res.ok) {
          onProgress(100);
          return await res.json(); // Drive file resource
        } else {
          throw new Error('upload ' + res.status);
        }
      }
    }

    document.getElementById('picker').addEventListener('change', async (e) => {
      if (!accessToken) { setLine('Click Authorize first.', 'warn'); alert('Click Authorize first.'); return; }
      const folderId = document.getElementById('folder').value.trim();

      for (const file of e.target.files) {
        const ui = row(file.name);
        const progress = ui.querySelector('progress');
        const status = ui.querySelector('[data-status]');
        try {
          status.textContent = 'Starting session…';
          const sessionUrl = await startResumable(file, folderId);
          status.textContent = 'Uploading…';
          const result = await uploadChunks(sessionUrl, file, pct => progress.value = pct);
          const fileId = result.id;
          status.innerHTML = `Done — https://drive.google.com/file/d/${fileId}/view`;
          setLine('Upload complete.', 'ok');
        } catch (err) {
          status.textContent = 'Error: ' + err.message;
          setLine('Upload failed: ' + err.message, 'err');
          logLast('Upload error');
          logErr(err.message);
        }
      }
    });
  </script>
</body>
</html>
